{% extends "base.html" %}

{% block title %}Job Status - AI Content Curator{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 p-8 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold text-white">Job Status</h1>
                <div class="flex space-x-2">
                    <button id="refresh-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button id="cancel-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors" style="display: none;">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>

            <!-- Job Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white/5 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-white mb-2">Job Details</h3>
                    <div class="space-y-2 text-gray-300">
                        <div><span class="font-medium">Job ID:</span> <code class="bg-gray-800 px-2 py-1 rounded text-sm">{{ job_id }}</code></div>
                        <div><span class="font-medium">Type:</span> <span id="job-type">{{ status.type or 'Unknown' }}</span></div>
                        <div><span class="font-medium">Submitted:</span> <span id="submitted-at">{{ status.submitted_at or 'Unknown' }}</span></div>
                        <div><span class="font-medium">State:</span> <span id="job-state" class="px-2 py-1 rounded text-sm">{{ status.state or 'Unknown' }}</span></div>
                    </div>
                </div>

                <div class="bg-white/5 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-white mb-2">Progress</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm text-gray-300 mb-1">
                                <span>Progress</span>
                                <span><span id="current-count">{{ status.current or 0 }}</span> / <span id="total-count">{{ status.total or 0 }}</span></span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-300">
                            <span class="font-medium">Status:</span> <span id="status-message">{{ status.status or 'Waiting...' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <h3 class="text-xl font-semibold text-white mb-4">Results</h3>
                <div id="results-container" class="space-y-4">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <!-- Error Section -->
            <div id="error-section" class="hidden">
                <div class="bg-red-500/20 border border-red-500/50 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-red-400 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error
                    </h3>
                    <p id="error-message" class="text-red-300"></p>
                </div>
            </div>

            <!-- Processing Details -->
            <div id="processing-details" class="mt-6 hidden">
                <h3 class="text-lg font-semibold text-white mb-3">Processing Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white/5 rounded-xl p-4">
                        <h4 class="font-medium text-green-400 mb-2">
                            <i class="fas fa-check-circle mr-2"></i>Processed URLs
                        </h4>
                        <div id="processed-urls" class="text-sm text-gray-300 max-h-32 overflow-y-auto">
                            <!-- Processed URLs will be listed here -->
                        </div>
                    </div>
                    <div class="bg-white/5 rounded-xl p-4">
                        <h4 class="font-medium text-red-400 mb-2">
                            <i class="fas fa-exclamation-circle mr-2"></i>Failed URLs
                        </h4>
                        <div id="failed-urls" class="text-sm text-gray-300 max-h-32 overflow-y-auto">
                            <!-- Failed URLs will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobId = '{{ job_id }}';
    let pollInterval;
    
    // Elements
    const refreshBtn = document.getElementById('refresh-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const jobState = document.getElementById('job-state');
    const currentCount = document.getElementById('current-count');
    const totalCount = document.getElementById('total-count');
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');
    const resultsSection = document.getElementById('results-section');
    const resultsContainer = document.getElementById('results-container');
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    const processingDetails = document.getElementById('processing-details');
    const processedUrls = document.getElementById('processed-urls');
    const failedUrls = document.getElementById('failed-urls');
    
    function updateJobStatus(status) {
        // Update basic info
        jobState.textContent = status.state || 'Unknown';
        jobState.className = `px-2 py-1 rounded text-sm ${getStateColor(status.state)}`;
        
        // Update progress
        const current = status.current || 0;
        const total = status.total || 0;
        currentCount.textContent = current;
        totalCount.textContent = total;
        
        const percentage = total > 0 ? (current / total) * 100 : 0;
        progressBar.style.width = `${percentage}%`;
        
        // Update status message
        statusMessage.textContent = status.status || 'Waiting...';
        
        // Show/hide cancel button
        if (status.state === 'PENDING' || status.state === 'PROGRESS') {
            cancelBtn.style.display = 'block';
        } else {
            cancelBtn.style.display = 'none';
        }
        
        // Handle different states
        if (status.state === 'SUCCESS') {
            showResults(status.result);
            stopPolling();
        } else if (status.state === 'FAILURE') {
            showError(status.error || 'Job failed');
            stopPolling();
        } else if (status.state === 'PROGRESS') {
            showProcessingDetails(status);
        }
    }
    
    function getStateColor(state) {
        switch (state) {
            case 'PENDING': return 'bg-yellow-600 text-yellow-100';
            case 'PROGRESS': return 'bg-blue-600 text-blue-100';
            case 'SUCCESS': return 'bg-green-600 text-green-100';
            case 'FAILURE': return 'bg-red-600 text-red-100';
            default: return 'bg-gray-600 text-gray-100';
        }
    }
    
    function showResults(result) {
        if (!result || !result.results) return;
        
        resultsSection.classList.remove('hidden');
        
        const results = result.results;
        resultsContainer.innerHTML = '';
        
        results.forEach((item, index) => {
            const article = item.article || {};
            const card = document.createElement('div');
            card.className = 'bg-white/5 rounded-xl p-4 border border-white/10';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-white text-lg">${article.title || 'Untitled'}</h4>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-blue-400">${item.overall_score || 0}</div>
                        <div class="text-xs text-gray-400">Overall Score</div>
                    </div>
                </div>
                
                <div class="text-sm text-gray-300 mb-3">
                    <div><strong>Author:</strong> ${article.author || 'Unknown'}</div>
                    <div><strong>Published:</strong> ${article.publish_date ? new Date(article.publish_date).toLocaleDateString() : 'Unknown'}</div>
                    <div><strong>URL:</strong> <a href="${article.url}" target="_blank" class="text-blue-400 hover:text-blue-300">${article.url}</a></div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-3">
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-400">Readability</div>
                        <div class="text-lg font-bold text-white">${item.readability_score || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-400">NER Density</div>
                        <div class="text-lg font-bold text-white">${item.ner_density_score || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-400">Sentiment</div>
                        <div class="text-lg font-bold text-white">${item.sentiment_score || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-400">Relevance</div>
                        <div class="text-lg font-bold text-white">${item.tfidf_relevance_score || 0}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm font-medium text-gray-400">Recency</div>
                        <div class="text-lg font-bold text-white">${item.recency_score || 0}</div>
                    </div>
                </div>
                
                ${article.summary ? `<p class="text-gray-300 text-sm">${article.summary}</p>` : ''}
            `;
            
            resultsContainer.appendChild(card);
        });
    }
    
    function showError(error) {
        errorSection.classList.remove('hidden');
        errorMessage.textContent = error;
    }
    
    function showProcessingDetails(status) {
        if (status.processed_urls || status.failed_urls) {
            processingDetails.classList.remove('hidden');
            
            // Update processed URLs
            if (status.processed_urls) {
                processedUrls.innerHTML = status.processed_urls.map(url => 
                    `<div class="truncate">${url}</div>`
                ).join('');
            }
            
            // Update failed URLs
            if (status.failed_urls) {
                failedUrls.innerHTML = status.failed_urls.map(url => 
                    `<div class="truncate">${url}</div>`
                ).join('');
            }
        }
    }
    
    function fetchJobStatus() {
        fetch(`/jobs/${jobId}/status`)
            .then(response => response.json())
            .then(status => {
                updateJobStatus(status);
            })
            .catch(error => {
                console.error('Error fetching job status:', error);
                showError('Failed to fetch job status');
            });
    }
    
    function startPolling() {
        fetchJobStatus(); // Initial fetch
        pollInterval = setInterval(fetchJobStatus, 2000); // Poll every 2 seconds
    }
    
    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    // Event listeners
    refreshBtn.addEventListener('click', fetchJobStatus);
    
    cancelBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel this job?')) {
            fetch(`/jobs/${jobId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'cancelled') {
                        statusMessage.textContent = 'Job cancelled';
                        jobState.textContent = 'CANCELLED';
                        jobState.className = 'px-2 py-1 rounded text-sm bg-orange-600 text-orange-100';
                        cancelBtn.style.display = 'none';
                        stopPolling();
                    } else {
                        alert('Failed to cancel job');
                    }
                })
                .catch(error => {
                    console.error('Error cancelling job:', error);
                    alert('Failed to cancel job');
                });
        }
    });
    
    // Start polling on page load
    startPolling();
    
    // Clean up on page unload
    window.addEventListener('beforeunload', stopPolling);
});
</script>
{% endblock %}